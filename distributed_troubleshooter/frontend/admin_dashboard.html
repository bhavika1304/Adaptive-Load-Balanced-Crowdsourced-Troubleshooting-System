<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Admin Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      background-color: #fdfbff;
      font-family: 'Segoe UI', sans-serif;
    }

    .card {
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(186, 140, 216, 0.1);
    }

    .btn-primary {
      background-color: #c9a0dc;
      border: none;
    }

    .btn-outline-danger {
      border-color: #dc7b94;
      color: #dc7b94;
    }

    .btn-outline-danger:hover {
      background-color: #dc7b94;
      color: white;
    }

    .badge-region {
      font-size: 0.7rem;
      border-radius: 8px;
      padding: 4px 8px;
    }

    .badge-north { background-color: #e6e6fa; color: #6a5acd; }
    .badge-south { background-color: #ffe4e1; color: #c26a6a; }
    .badge-east  { background-color: #e0fff4; color: #4caf8f; }
    .badge-west  { background-color: #fff8dc; color: #b8860b; }

    .region-card {
      border-left: 6px solid #e0c3fc;
      background-color: #f9f6ff;
    }
  </style>
</head>
<body class="bg-light">

  <div class="container mt-5">
    <h2 class="text-center mb-4 text-purple">Admin Dashboard 💼</h2>

    <!-- Expert Panel -->
    <div class="card p-4 mb-4">
      <h5>👨‍🔧 Pending Expert Verifications</h5>
      <button class="btn btn-primary mt-2 mb-3" onclick="loadExperts()">Load Expert Submissions</button>
      <div id="experts"></div>
    </div>

    <!-- Region Stats -->
    <div class="card p-4 mb-4 region-card">
      <h5>📊 Region Statistics</h5>
      <div id="region-stats" class="mt-2"></div>
    </div>

    <!-- Region Chart -->
    <div class="card p-4 mb-4">
      <h5>📈 Live Load per Region</h5>
      <canvas id="regionChart" height="180"></canvas>
    </div>

    <!-- Issues by Region -->
    <div class="card p-4 mb-4">
      <h5>🛰️ Issues Grouped by Region</h5>
      <div id="issues-by-region" class="mt-2"></div>
    </div>

    <!-- Rerouted -->
    <div class="card p-4 mb-4">
      <h5>🔁 Rerouted Issues</h5>
      <div id="rerouted-issues" class="mt-2"></div>
    </div>


    <!-- Logout -->
    <div class="text-center">
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <script>
    const BASE_URL = "http://localhost:8000";

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    function loadExperts() {
      const token = localStorage.getItem("token");

      fetch(`${BASE_URL}/experts_unverified`, {
        method: "GET",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(data => displayExperts(data))
      .catch(() => {
        document.getElementById("experts").innerHTML = "<p class='text-danger'>Failed to load experts.</p>";
      });
    }

    function displayExperts(experts) {
      const container = document.getElementById("experts");
      container.innerHTML = "";

      if (!experts.length) {
        container.innerHTML = "<p class='text-muted text-center'>No pending experts found.</p>";
        return;
      }

      experts.forEach(expert => {
        const card = document.createElement("div");
        card.className = "card mb-3 p-3";

        card.innerHTML = `
          <h5>${expert.name}</h5>
          <p><strong>Email:</strong> ${expert.email}</p>
          <p><strong>Qualifications:</strong> ${expert.qualifications}</p>
          <p><strong>Experience:</strong> ${expert.experience_years} years</p>
          <p><strong>Quiz Score:</strong> ${expert.quiz_score}</p>
          <p><strong>Portfolio:</strong> <a href="${expert.portfolio_url}" target="_blank">${expert.portfolio_url}</a></p>
          <p><strong>Resume:</strong> ${expert.proof_resume}</p>
          <textarea id="note-${expert.expert_id}" class="form-control mb-2" placeholder="Verification notes (optional)"></textarea>
          <button class="btn btn-success" onclick="verifyExpert('${expert.expert_id}')">Verify</button>
        `;

        container.appendChild(card);
      });
    }

    function verifyExpert(expert_id) {
      const token = localStorage.getItem("token");
      const notes = document.getElementById(`note-${expert_id}`).value;

      fetch(`${BASE_URL}/admin/verify_expert/${expert_id}?notes=${encodeURIComponent(notes)}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`
        }
      })
      .then(res => res.json())
      .then(() => {
        alert("Expert verified.");
        loadExperts();
      })
      .catch(() => alert("Failed to verify expert."));
    }

    function loadRegionStats() {
      fetch(`${BASE_URL}/region_stats`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(stats => {
        const div = document.getElementById("region-stats");
        div.innerHTML = "";
        for (const region in stats) {
          const s = stats[region];
          div.innerHTML += `<p><strong>${region.toUpperCase()}</strong>: 🛠️ ${s.active_issues} active | 👨‍💻 ${s.available_experts} available experts</p>`;
        }
      });
    }

    function loadIssuesByRegion() {
      fetch(`${BASE_URL}/all_issues_by_region`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(grouped => {
        const div = document.getElementById("issues-by-region");
        div.innerHTML = "";

        if (typeof grouped !== 'object' || grouped === null) {
          div.innerHTML = "<p class='text-danger'>Invalid data received.</p>";
          return;
        }

        for (const region in grouped) {
          const issues = Array.isArray(grouped[region]) ? grouped[region] : [];
          div.innerHTML += `<h5 class="mt-3">${region.toUpperCase()} (${issues.length} issues)</h5>`;
          issues.forEach(issue => {
            div.innerHTML += `<div class="border rounded p-2 mb-2 bg-white">
              <strong>${issue.title}</strong> — ${issue.status} <br/>
              Assigned: ${issue.assigned_expert || "Not Assigned"}
            </div>`;
          });
        }
      })
      .catch(() => {
        document.getElementById("issues-by-region").innerHTML = "<p class='text-danger'>Failed to load issues.</p>";
      });
    }

    function loadReroutedIssues() {
      fetch(`${BASE_URL}/rerouted_issues`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(data => {
        const div = document.getElementById("rerouted-issues");
        if (!data.length) {
          div.innerHTML = "<p class='text-muted'>No rerouted issues found.</p>";
          return;
        }
        div.innerHTML = "";
        data.forEach(issue => {
          let logEntries = issue.reassignment_log.map(r => {
            const ts = new Date(r.timestamp).toLocaleString();
            return `➡️ ${r.expert_id} (${ts})`;
          }).join("<br>");

          div.innerHTML += `<div class="border rounded p-2 mb-3 bg-white">
            <strong>${issue.title}</strong> — <code>${issue.issue_id}</code><br/>
            <small>Region: ${issue.region}</small><br/>
            ${logEntries}
          </div>`;
        });
      });
    }

    let regionChart;

    function drawRegionChart(stats) {
      const ctx = document.getElementById('regionChart').getContext('2d');
      const labels = Object.keys(stats).map(r => r.toUpperCase());
      const data = Object.values(stats).map(r => r.active_issues);

      if (regionChart) {
        regionChart.data.labels = labels;
        regionChart.data.datasets[0].data = data;
        regionChart.update();
      } else {
        regionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Active Issues',
              data,
              backgroundColor: 'rgba(54, 162, 235, 0.6)'
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: { beginAtZero: true, stepSize: 1 }
            }
          }
        });
      }
    }

    function loadRegionStats() {
      fetch(`${BASE_URL}/region_stats`, {
        headers: { "Authorization": `Bearer ${localStorage.getItem("token")}` }
      })
      .then(res => res.json())
      .then(stats => {
        const div = document.getElementById("region-stats");
        div.innerHTML = "";
        for (const region in stats) {
          const s = stats[region];
          div.innerHTML += `<p><strong>${region.toUpperCase()}</strong>: 🛠️ ${s.active_issues} active | 👨‍💻 ${s.available_experts} available experts</p>`;
        }
        drawRegionChart(stats);  // ✅ Update chart
      });
    }


    window.onload = () => {
      loadExperts();
      loadRegionStats();
      loadIssuesByRegion();
      loadReroutedIssues();  // ✅ new addition
    };

  </script>

</body>
</html>
