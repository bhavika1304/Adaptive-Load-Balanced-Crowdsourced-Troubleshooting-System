<!-- âœ… Updated User Dashboard with Star Rating -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>User Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css">

  <style>
    body {
      background-color: #faf6ff;
      font-family: 'Segoe UI', sans-serif;
    }

    h2, h4 {
      color: #865fc5;
    }

    .card {
      border-radius: 12px;
      background-color: #f6f0ff;
      box-shadow: 0 4px 10px rgba(134, 95, 197, 0.1);
      border: none;
    }

    .btn {
      font-weight: 500;
    }

    .btn-primary {
      background-color: #caa6f7;
      border-color: #caa6f7;
    }

    .btn-primary:hover {
      background-color: #b788eb;
    }

    .btn-outline-danger {
      color: #c26a6a;
      border-color: #c26a6a;
    }

    .btn-outline-danger:hover {
      background-color: #fceaea;
    }

    .btn-outline-primary {
      color: #865fc5;
      border-color: #865fc5;
    }

    .btn-outline-primary:hover {
      background-color: #ede4ff;
    }

    .btn-warning {
      background-color: #ffe9b0;
      border-color: #ffe9b0;
      color: #6c4d00;
    }

    .btn-warning:hover {
      background-color: #ffdfa1;
    }

    .btn-danger {
      background-color: #f7c4cb;
      border-color: #f7c4cb;
    }

    .btn-danger:hover {
      background-color: #f09ca7;
    }

    .chat-box {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      margin-top: 10px;
      background: #fdf4ff;
      border-radius: 8px;
    }

    .text-north { color: #6a5acd; }     .bg-north { background-color: #e6e6fa; }
    .text-south { color: #c26a6a; }     .bg-south { background-color: #ffe4e1; }
    .text-east  { color: #4caf8f; }     .bg-east  { background-color: #e0fff4; }
    .text-west  { color: #b8860b; }     .bg-west  { background-color: #fff8dc; }

    .issue-card {
      border-left: 6px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 16px;
      background-color: #ffffff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }

    .badge-status {
      padding: 0.4em 0.6em;
      border-radius: 1em;
      font-size: 0.75rem;
      font-weight: 500;
    }

    .badge-assigned { background-color: #c3e6cb; color: #155724; }
    .badge-pending  { background-color: #ffeeba; color: #856404; }
    .badge-closed   { background-color: #d6d8d9; color: #383d41; }
    .badge-rerouted { background-color: #d1ecf1; color: #0c5460; }
    .badge-rejected { background-color: #f8d7da; color: #721c24; }

    .star {
      font-size: 22px;
      cursor: pointer;
      color: gray;
    }

    .star.selected {
      color: gold;
    }

    .profile-icon {
      position: absolute;
      top: 20px;
      right: 30px;
      font-size: 22px;
      cursor: pointer;
    }
  </style>

</head>
<body class="bg-light">

  <div class="profile-icon">
    <a href="profile.html" title="My Profile">ðŸ‘¤</a>
  </div>

  <div class="container mt-5">
    <h2 class="text-center mb-4">Welcome, User</h2>

    <!-- âœ… New Issue Form -->
    <div class="card p-4">
      <h4 class="mb-3">Submit a New Issue</h4>

      <div class="mb-3">
        <label>Title</label>
        <input id="issue-title" class="form-control" type="text">
      </div>

      <div class="mb-3">
        <label>Description</label>
        <textarea id="issue-description" class="form-control"></textarea>
        <small class="text-muted">ðŸ§  Tip: Use detailed keywords for better expert matching.</small>
      </div>

      <div class="mb-3">
        <label>Category</label>
        <select id="issue-category" class="form-select">
          <option value="">Select a category</option>
          <option value="network">Network</option>
          <option value="hardware">Hardware</option>
          <option value="software">Software</option>
          <option value="database">Database</option>
          <option value="security">Security</option>
          <option value="machine learning">Machine Learning</option>
          <option value="deep learning">Deep Learning</option>
          <option value="full stack development">Full Stack Development</option>
          <option value="other">Other</option>
        </select>
      </div>

      <div class="mb-3">
        <label>Urgency (1â€“5)</label>
        <input id="issue-urgency" class="form-control" type="number" min="1" max="5">
      </div>

      <button class="btn w-100 text-purple" onclick="submitIssue()">Submit Issue</button>
      <div id="issue-message" class="mt-3 text-center text-success"></div>
    </div>

    <!-- âœ… Submitted Issues -->
    <div class="card p-4 mt-4">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h4 class="mb-0">My Submitted Issues</h4>
        <button id="toggle-old" class="btn btn-sm btn-outline-secondary" onclick="toggleOldIssues()">View Older Issues</button>
      </div>
      <div id="issue-list"></div>
    </div>

    <div class="text-center mt-4">
      <button class="btn btn-outline-danger" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- â­ Rating Modal -->
  <div class="modal fade" id="ratingModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content p-4">
        <h5 class="modal-title">Rate the Expert</h5>
        <input type="hidden" id="rating-issue-id">
        <input type="hidden" id="rating-recipient-id">
        <div class="mb-3 text-center" id="rating-stars">
          <span class="star" data-value="1">â˜…</span>
          <span class="star" data-value="2">â˜…</span>
          <span class="star" data-value="3">â˜…</span>
          <span class="star" data-value="4">â˜…</span>
          <span class="star" data-value="5">â˜…</span>
        </div>
        <textarea id="rating-comment" class="form-control mb-3" placeholder="Leave a comment..."></textarea>
        <div class="text-end">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button class="btn btn-success" onclick="submitRating()">Submit</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const BASE_URL = "http://localhost:8000";
    const token = localStorage.getItem("token");

    const userId = localStorage.getItem("user_id");
    const ws = new WebSocket(`ws://localhost:8000/ws/${userId}`);

    ws.onmessage = (event) => {
      try {
        const parsed = JSON.parse(event.data);
        const eventName = parsed.event;
        const payload = parsed.data;

        console.log("ðŸ“¡ Received:", eventName, payload);

        switch (eventName) {
          case "new_message":
            if (payload.issue_id) loadChat(payload.issue_id);
            break;
          case "issue_assigned":
            if (payload.issue_id) {
              loadMyIssues();        // âœ… Refresh issue info
              loadChat(payload.issue_id);  // âœ… Refresh chat if reopened
            }
            if (payload.message) {
              alert(payload.message);  // âœ… Show alert if any custom message sent from backend
            }
            break;
          case "issue_started":
          case "resolution_submitted":
            if (payload.issue_id) {
              loadMyIssues();
              loadChat(payload.issue_id);
            }
            break;
          case "issue_closed":
            if (payload.issue_id) {
              loadMyIssues();
              const issueId = payload.issue_id;
              const expertId = document.querySelector(`[data-issue-id="${issueId}"]`)?.dataset?.expertId || "";
              if (expertId) {
                document.getElementById("rating-issue-id").value = issueId;
                document.getElementById("rating-recipient-id").value = expertId;
                selectedRating = 0;
                document.getElementById("rating-comment").value = "";
                document.querySelectorAll(".star").forEach(star => star.classList.remove("selected"));
                new bootstrap.Modal(document.getElementById("ratingModal")).show();
              }
            }
            break;

          case "issue_deleted":
            alert(payload.message || "Issue deleted.");
            loadMyIssues();  // ðŸ” Refresh issues list
            break;
          case "expert_rated":
          case "user_rated":
            alert("New feedback received!");
            break;

          case "no_expert_now":
            alert("âš ï¸ No expert currently available. We'll notify you once reassigned.");
            break;
        }
      } catch (err) {
        console.error("âŒ Invalid WS message:", event.data);
      }
    };



    ws.onopen = () => console.log("âœ… WebSocket connected");
    ws.onerror = (err) => console.error("âŒ WebSocket error", err);
    ws.onclose = () => console.log("ðŸ”Œ WebSocket disconnected");
    setInterval(() => {
      if (ws.readyState !== WebSocket.OPEN) {
        console.warn("ðŸ” WebSocket not open, reloading...");
        window.location.reload();  // or reconnect
      }
    }, 6000);

    const chatIntervals = {};
    let selectedRating = 0;
    let showAllIssues = false;

    function logout() {
      localStorage.removeItem("token");
      window.location.href = "index.html";
    }

    function toggleOldIssues() {
      showAllIssues = !showAllIssues;
      document.getElementById("toggle-old").innerText = showAllIssues ? "Hide Older Issues" : "View Older Issues";
      loadMyIssues();
    }

    function submitIssue() {
      const title = document.getElementById("issue-title").value;
      const description = document.getElementById("issue-description").value;
      const category = document.getElementById("issue-category").value;
      const urgency = parseInt(document.getElementById("issue-urgency").value);

      fetch(`${BASE_URL}/report_issue`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify({ title, description, category, urgency })
      })
      .then(res => res.json())
      .then(data => {
        document.getElementById("issue-message").innerText = data.message || "Issue submitted!";
        loadMyIssues();
      })
      .catch(() => {
        document.getElementById("issue-message").innerText = "Error submitting issue.";
      });

      document.getElementById("issue-title").value = "";
      document.getElementById("issue-description").value = "";
      document.getElementById("issue-category").value = "";
      document.getElementById("issue-urgency").value = "";
    }

    function loadMyIssues() {
      fetch(`${BASE_URL}/my_issues`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById("issue-list");
        container.innerHTML = "";

        const ongoingStatuses = ["pending", "assigned", "in_progress", "awaiting_expert_confirmation", "awaiting_user_confirmation"];
        const issuesToShow = showAllIssues ? data : data.filter(issue => ongoingStatuses.includes(issue.status));

        if (!data.length) {
          container.innerHTML = "<p class='text-muted'>No issues submitted yet.</p>";
          return;
        }

        issuesToShow.forEach(issue => {
          const expert = issue.assigned_expert || "Not Assigned";
          let status = issue.status || "pending";
          let statusLabel = status;

          if (status === "in_progress") statusLabel = "In Progress";
          if (status === "awaiting_user_confirmation") statusLabel = "Waiting for You";
          if (status === "awaiting_expert_confirmation") statusLabel = "Waiting for Expert";
          if (status === "closed") statusLabel = "Resolved";


          const chatId = `chat-${issue.issue_id}`;

          const card = document.createElement("div");
          card.className = "border rounded p-3 mb-4 bg-white shadow-sm";
          card.dataset.issueId = issue.issue_id;
          card.dataset.expertId = issue.assigned_expert_id || "";

          card.innerHTML = `
            <h5>${issue.title}</h5>
            <p><strong>Status:</strong> <span class="badge badge-status badge-${status}">${statusLabel}</span></p>
            <p><strong>Assigned Expert:</strong> ${expert}</p>

            ${issue.resolution_notes ? `
              <div class="mt-2 p-2 bg-light border rounded">
                <strong>Expert's Resolution:</strong>
                <p class="mb-0">${issue.resolution_notes}</p>
              </div>
            ` : ''}

            ${expert !== "Not Assigned" ? `
              <div class="chat-box" id="${chatId}">Loading chat...</div>
              <div class="input-group mt-2">
                <input type="text" class="form-control" id="msg-${issue.issue_id}" placeholder="Type a message...">
                <button class="btn btn-outline-primary" onclick="sendMessage('${issue.issue_id}')">Send</button>
              </div>
            ` : ''}
            <div class="d-flex flex-wrap gap-2 mt-3">
              ${(status === "in_progress" || status === "awaiting_expert_confirmation" || status === "awaiting_user_confirmation") ? `
                <button class="btn btn-success flex-fill" onclick="markAsDone('${issue.issue_id}', '${issue.assigned_expert}')">Mark as Done</button>
              ` : ''}
              <button class="btn btn-danger flex-fill" onclick="deleteIssue('${issue.issue_id}')">Delete Issue</button>
              <button class="btn btn-warning flex-fill" onclick="escalateIssue('${issue.issue_id}')">Still Not Solved?</button>
            </div>

        `;

          container.appendChild(card);

          if (expert !== "Not Assigned") {
            loadChat(issue.issue_id);
            if (!chatIntervals[issue.issue_id]) {
              chatIntervals[issue.issue_id] = setInterval(() => loadChat(issue.issue_id), 7000);
            }
          }
        });
      })
      .catch(() => {
        document.getElementById("issue-list").innerText = "Failed to load issues.";
      });
    }

    function markAsDone(issueId, expertId) {
      fetch(`${BASE_URL}/mark_done/${issueId}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        console.log("âœ… Done status:", data.status);
        console.log("ðŸ” Closing issue. Showing rating for:", expertId);
        if (data.status === "closed" && data.request_feedback) {
          document.getElementById("rating-issue-id").value = issueId;
          document.getElementById("rating-recipient-id").value = expertId;
          selectedRating = 0;
          document.getElementById("rating-comment").value = "";
          document.querySelectorAll(".star").forEach(star => star.classList.remove("selected"));
          new bootstrap.Modal(document.getElementById("ratingModal")).show();
        } else {
          alert("Marked as done. Waiting for expert to confirm.");
          loadMyIssues();
        }
      })
      .catch(() => alert("Failed to mark as done."));
    }

    function deleteIssue(issueId) {
      if (!confirm("Are you sure you want to delete this issue?")) return;

      fetch(`${BASE_URL}/delete_issue/${issueId}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Issue deleted.");
        loadMyIssues();
      })
      .catch(() => alert("Failed to delete issue."));
    }

    function submitRating() {
      const issue_id = document.getElementById("rating-issue-id").value;
      const recipient_id = document.getElementById("rating-recipient-id").value;
      const comment = document.getElementById("rating-comment").value;

      if (!selectedRating) return alert("Please select a rating.");

      fetch(`${BASE_URL}/rate_expert`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          issue_id, expert_id: recipient_id,
          rating: selectedRating,
          comment
        })
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Rating submitted.");
        bootstrap.Modal.getInstance(document.getElementById("ratingModal")).hide();
        loadMyIssues();
      })
      .catch(() => alert("Failed to submit rating."));
    }

    document.querySelectorAll(".star").forEach(star => {
      star.addEventListener("click", () => {
        selectedRating = parseInt(star.dataset.value);
        document.querySelectorAll(".star").forEach(s => s.classList.remove("selected"));
        for (let i = 0; i < selectedRating; i++) {
          document.querySelectorAll(".star")[i].classList.add("selected");
        }
      });
    });

    function loadChat(issueId) {
      fetch(`${BASE_URL}/messages/${issueId}`, {
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(messages => {
        if (!Array.isArray(messages)) {
          console.error("Expected array, got:", messages);
          return;
        }
        const box = document.getElementById(`chat-${issueId}`);
        box.innerHTML = "";
        messages.forEach(msg => {
          const bubble = document.createElement("div");
          bubble.className = "mb-1";
          bubble.innerHTML = `<strong>${msg.sender_role}:</strong> ${msg.content}`;
          box.appendChild(bubble);
        });
        box.scrollTop = box.scrollHeight;
      });
    }

    function sendMessage(issueId) {
      const input = document.getElementById(`msg-${issueId}`);
      const content = input.value.trim();
      if (!content) return;

      fetch(`${BASE_URL}/messages/${issueId}`, {
        method: "POST",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ message: content })
      })
      .then(res => res.json())
      .then(() => {
        input.value = "";
        loadChat(issueId);
        setTimeout(() => loadChat(issueId), 1000);
      });
    }

    function escalateIssue(issueId) {
      if (!confirm("Escalate this issue to another expert?")) return;
      fetch(`${BASE_URL}/escalate_issue/${issueId}`, {
        method: "POST",
        headers: { "Authorization": `Bearer ${token}` }
      })
      .then(res => res.json())
      .then(data => {
        alert(data.message || "Escalation triggered.");
        loadMyIssues();
      })
      .catch(() => alert("Failed to escalate issue."));
    }

    window.onload = loadMyIssues;
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
